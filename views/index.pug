extends layout

block scripts
  script(src='/javascripts/d3.v3.min.js')
  // v3 to keep the refs to d3.scale.linear()
  // v5 will start using eg d3.scaleLinear etc.

block title
  h1= siteName
  p Welcome to #{siteName}
  hr

block content
  .container
    .row
      .col-12
        h2 Daily Watering Time (Past 30 Days)
        canvas#wateringChart(width="400" height="200")
        
  script(src="https://cdn.jsdelivr.net/npm/chart.js")
  script(type="text/javascript").
    document.addEventListener('DOMContentLoaded', function() {
      // Fetch watering data and create chart
      fetch('/api/watering-stats/daily')
        .then(response => response.json())
        .then(data => {
          createWateringChart(data);
        })
        .catch(error => {
          console.error('Error loading watering data:', error);
        });
    });
    
    function createWateringChart(data) {
        const ctx = document.getElementById('wateringChart').getContext('2d');
        
        // Prepare data for Chart.js
        const labels = data.map(d => {
        const date = new Date(d.date);
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        });
        
        const values = data.map(d => d.total_minutes);
        
        // Bar chart (as requested)
        new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
            label: 'Total Watering Time (minutes)',
            data: values,
            backgroundColor: 'rgba(54, 162, 235, 0.8)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
            title: {
                display: true,
                text: 'Daily Watering Duration'
            },
            legend: {
                display: false
            }
            },
            scales: {
            y: {
                beginAtZero: true,
                title: {
                display: true,
                text: 'Minutes'
                }
            },
            x: {
                title: {
                display: true,
                text: 'Date'
                }
            }
            }
        }
        });
    }